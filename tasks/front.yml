---
    - name: Copy 'is_cluster_ready' file
      copy: dest=/bin/is_cluster_ready src=is_cluster_ready mode=0755

     # Manage the /etc/hosts file
    - shell: |
        for i in `seq 1 {{item.ec3_max_instances_max|int }}`; do
          item="{{item.id|replace('_','x')}}${i}";
          grep -q "\<${item}\>" /etc/hosts || echo "127.0.0.1 ${item} ${item}.localdomain" >> /etc/hosts;
        done
      with_items: '{{ SYSTEMS | selectattr("ec3_max_instances_max", "defined") | list }}'

    - name: Obtain master IP in Deb systems
      shell: ifconfig eth0 | sed -n '/inet addr/s/.*addr.\([^ ]*\) .*/\1/p'
      #shell:  wget -qO- ifconfig.me/ip
      register: master_ip_deb
      when: ansible_os_family == "Debian"

    - name: Obtain master IP in RedHat systems
      shell: ifconfig ens3 | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1'
      register: master_ip_rht
      when: ansible_os_family == "RedHat"

    - name: Obtain master nodename
      shell: hostname | cut -d "." -f 1
      register: master_hostname

    - name: Set ZooKeeper URL (debian)# used for leader election amongst masters
      copy:
        #content: "zk://{{IM_NODE_PUBLIC_IP}}:2181/mesos"
        content: "zk://{{master_ip_deb.stdout}}:2181/mesos"
        dest: /etc/mesos/zk
        mode: 0644
      when: ansible_os_family == "Debian"

    - name: Set ZooKeeper URL (redhat)# used for leader election amongst masters
      copy:
        content: "zk://{{master_ip_rht.stdout}}:2181/mesos"
        dest: /etc/mesos/zk
        mode: 0644
      when: ansible_os_family == "RedHat"

    - name: start up zookeeper
      service: name=zookeeper state=started enabled=yes

    # Master tasks
    # Disable mesos-slave in Debian
    - name: Stop the Mesos Slave service
      service: name=mesos-slave state=stopped
      when: ansible_os_family == "Debian"

    - name: Disable the Mesos Slave service
      copy:
        content: "manual"
        dest: /etc/init/mesos-slave.override
        mode: 0644
      when: ansible_os_family == "Debian"

    # Disable mesos-slave in Redhat
    - name: Stop the Mesos Slave service
      command: systemctl stop mesos-slave.service
      when: ansible_os_family == "RedHat"

    - name: Disable the Mesos Slave service
      command: systemctl disable mesos-slave.service
      when: ansible_os_family == "RedHat"
 
    - name: Set Mesos Master hostname
      copy:
        content: "{{master_hostname.stdout}}"
        dest: /etc/mesos-master/hostname
        mode: 0644

    # Tambien se puede configurar la ip del master con (export MESOS_IP=158.42.104.229)
    - name: Set Mesos Master ip (debian)
      copy:
        content: "{{master_ip_deb.stdout}}"
        dest: /etc/mesos-master/ip
        mode: 0644
      when: ansible_os_family == "Debian"

    - name: Set Mesos Master ip (redhat)
      copy:
        content: "{{master_ip_rht.stdout}}"
        dest: /etc/mesos-master/ip
        mode: 0644
      when: ansible_os_family == "RedHat"
 
    - name: Set Mesos Master quorum count
      copy:
        content: "{{QUORUM}}"
        dest: /etc/mesos-master/quorum
        mode: 0644

    - name: start up the mesos-master
      service: name=mesos-master state=started enabled=yes

    - file: path=/etc/clues2/ state=directory
    - copy:
        content: |
           {% for number in range(1, NNODES|int + 1) %}
           vnode{{number}}
           {% endfor %}
        dest: "/etc/clues2/mesos_vnodes.info"

